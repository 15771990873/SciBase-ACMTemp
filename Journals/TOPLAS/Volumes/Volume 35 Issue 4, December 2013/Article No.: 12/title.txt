Making the java memory model safe