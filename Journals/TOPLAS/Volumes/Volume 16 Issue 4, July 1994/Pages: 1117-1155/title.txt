Optimal code motion: theory and practice