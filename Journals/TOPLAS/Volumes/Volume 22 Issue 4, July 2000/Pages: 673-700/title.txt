Program transformation and runtime support for threaded MPI execution on shared-memory machines