End-to-end optimal algorithms for integrated QoS, traffic engineering, and failure recovery