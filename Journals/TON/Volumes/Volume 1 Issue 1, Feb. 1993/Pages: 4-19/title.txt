A language-based approach to protocol implementation