Formalizing and verifying protocol refinements