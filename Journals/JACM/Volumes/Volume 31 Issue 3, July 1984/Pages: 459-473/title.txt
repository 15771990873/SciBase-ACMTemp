Solving NP-Hard Problems on Graphs That Are Almost Trees and an Application to Facility Location Problems